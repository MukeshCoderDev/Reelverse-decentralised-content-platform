# Penetration Testing Suite - Go-Live Sprint

Comprehensive penetration testing suite for backend services to identify security vulnerabilities before production deployment.

## Overview

This penetration testing suite provides automated security testing across multiple attack vectors:

1. **Authentication Testing** - JWT manipulation, brute force, SIWE bypass
2. **Authorization Testing** - Privilege escalation, access control bypass
3. **Injection Testing** - SQL, NoSQL, Command, Template injection
4. **Input Validation** - XSS, CSRF, file upload vulnerabilities
5. **Session Management** - Session fixation, hijacking, timeout issues
6. **Business Logic** - Payment manipulation, workflow bypass
7. **Information Disclosure** - Error messages, directory traversal
8. **Cryptography** - Weak encryption, certificate validation

## Quick Start

### Prerequisites

```bash
# No additional tools required - uses k6 HTTP client
# Ensure target application is running
npm run dev  # Start the application
```

### Running Penetration Tests

```bash
# Run full penetration test
node tests/pentest/run-pentest.js

# Run quick security scan (authentication only)
node tests/pentest/run-pentest.js --quick
```

### Package.json Scripts

```bash
# Run full pentest
npm run test:pentest

# Run quick scan
npm run test:pentest:quick
```

## Test Categories

### 1. Authentication Testing

Tests authentication mechanisms for common vulnerabilities:

**JWT Token Manipulation:**
- None algorithm attack
- Algorithm confusion (HS256 to RS256)
- Payload manipulation
- Signature removal
- Expired token usage

**SIWE (Sign-In With Ethereum) Testing:**
- Empty signature bypass
- Invalid signature format
- Reused signature attacks
- Modified message attacks

**Brute Force Protection:**
- Account lockout mechanisms
- Rate limiting effectiveness
- Bypass techniques (headers, IP rotation)

**Session Management:**
- Session fixation
- Session hijacking
- Concurrent session handling

### 2. Authorization Testing

Tests access control and privilege escalation:

**Privilege Escalation:**
- Vertical privilege escalation
- Role manipulation attacks
- JWT payload manipulation
- Parameter tampering

**Horizontal Access Control:**
- Accessing other users' data
- Parameter manipulation
- Direct object references

**Resource Access Control:**
- Premium content access without payment
- Payment data access controls
- User data privacy protection

### 3. Injection Testing

Tests for various injection vulnerabilities:

**SQL Injection:**
- Union-based injection
- Boolean-based blind injection
- Time-based blind injection
- Error-based injection

**NoSQL Injection:**
- MongoDB operator injection
- JavaScript injection
- Authentication bypass

**Command Injection:**
- OS command execution
- Time-based detection
- Blind command injection

**Template Injection:**
- Server-side template injection
- Code execution attempts
- Information disclosure

## Configuration

### Test Configuration (pentest-config.json)

```json
{
  "target": {
    "baseUrl": "http://localhost:3001",
    "apiPrefix": "/api/v1",
    "timeout": 30000
  },
  "authentication": {
    "testUsers": [
      {
        "role": "admin",
        "email": "admin@test.com",
        "walletAddress": "0x1234..."
      }
    ]
  },
  "testCategories": {
    "authentication": {
      "enabled": true,
      "severity": "critical"
    },
    "authorization": {
      "enabled": true,
      "severity": "critical"
    },
    "injection": {
      "enabled": true,
      "severity": "critical"
    }
  }
}
```

### Payload Configuration

The configuration includes predefined payloads for:
- SQL injection attacks
- XSS payloads
- Command injection strings
- Path traversal attempts
- NoSQL injection operators

## Security Test Scenarios

### Authentication Bypass Scenarios

```javascript
// JWT None Algorithm Attack
const manipulatedToken = token.replace(/"alg":"HS256"/, '"alg":"none"');

// SIWE Signature Bypass
const bypassAttempt = {
  message: "Sign in to platform",
  signature: "" // Empty signature
};

// Brute Force Attack
for (let i = 0; i < 100; i++) {
  attemptLogin(email, `password${i}`);
}
```

### Authorization Bypass Scenarios

```javascript
// Privilege Escalation via Parameter Tampering
const escalationAttempt = {
  userId: "victim-user-id",
  role: "admin",
  isAdmin: true
};

// Horizontal Access Control Bypass
const unauthorizedAccess = `/users/profile/${otherUserId}`;

// Direct Object Reference
const directAccess = `/payments/history/${otherUserAddress}`;
```

### Injection Attack Scenarios

```javascript
// SQL Injection
const sqlPayload = "' OR '1'='1' --";

// Command Injection
const cmdPayload = "; cat /etc/passwd";

// Template Injection
const templatePayload = "{{7*7}}";
```

## Vulnerability Detection

### Detection Methods

1. **Response Analysis**
   - Error message patterns
   - Response time analysis
   - Status code variations
   - Content length differences

2. **Behavioral Analysis**
   - Authentication bypass success
   - Unauthorized data access
   - Privilege escalation indicators
   - Injection execution evidence

3. **Time-based Detection**
   - SQL injection delays
   - Command injection timeouts
   - Template processing delays

### Severity Classification

**Critical (Deployment Blocking):**
- Authentication bypass
- SQL injection with data access
- Command injection with code execution
- Privilege escalation to admin

**High (Must Fix):**
- Authorization bypass
- Sensitive data exposure
- Session management flaws
- NoSQL injection

**Medium (Should Fix):**
- Information disclosure
- Input validation issues
- Weak session handling
- Minor access control issues

**Low (Nice to Fix):**
- Error message disclosure
- Minor configuration issues
- Non-exploitable findings

## Results and Reporting

### Output Files

```
tests/pentest/results/
├── pentest-report.json      # Detailed JSON results
├── pentest-report.html      # Interactive HTML report
├── executive-summary.md     # Executive summary
└── findings.csv            # CSV export for analysis
```

### Report Contents

**Executive Summary:**
- Overall risk assessment
- Critical findings count
- Go-live recommendation
- Remediation priorities

**Detailed Findings:**
- Vulnerability descriptions
- Proof of concept evidence
- Impact assessments
- Remediation guidance

**Technical Details:**
- Request/response evidence
- Payload information
- Exploitation steps
- Affected endpoints

## Go/No-Go Criteria

### Production Deployment Criteria

- ✅ **Zero Critical Vulnerabilities** - No critical security issues
- ✅ **Max 3 High Severity** - Limited high-severity findings
- ✅ **Max 10 Medium Severity** - Acceptable medium-risk issues
- ✅ **Authentication Security** - Strong authentication mechanisms
- ✅ **Authorization Controls** - Proper access controls implemented

### Risk Thresholds

```javascript
const deploymentCriteria = {
  critical: 0,        // Zero tolerance
  high: 3,           // Maximum 3 allowed
  medium: 10,        // Maximum 10 allowed
  low: 'unlimited'   // No limit
};
```

## Common Vulnerabilities Found

### 1. Authentication Issues

```javascript
// Weak JWT validation
if (!token) {
  return unauthorized();
}
// Missing signature verification!
const payload = jwt.decode(token); // Vulnerable
```

**Fix:**
```javascript
const payload = jwt.verify(token, secretKey); // Secure
```

### 2. Authorization Flaws

```javascript
// Missing ownership check
app.get('/users/:id', (req, res) => {
  const user = getUserById(req.params.id);
  res.json(user); // Vulnerable - no ownership check
});
```

**Fix:**
```javascript
app.get('/users/:id', authenticateUser, (req, res) => {
  if (req.user.id !== req.params.id && !req.user.isAdmin) {
    return res.status(403).json({ error: 'Forbidden' });
  }
  const user = getUserById(req.params.id);
  res.json(user);
});
```

### 3. SQL Injection

```javascript
// Vulnerable query
const query = `SELECT * FROM users WHERE email = '${email}'`;
```

**Fix:**
```javascript
const query = 'SELECT * FROM users WHERE email = ?';
db.query(query, [email]);
```

## Remediation Guidelines

### Critical Fixes (Immediate)

1. **Implement Proper Authentication**
   ```javascript
   // Use secure JWT validation
   const jwt = require('jsonwebtoken');
   const payload = jwt.verify(token, process.env.JWT_SECRET);
   ```

2. **Add Authorization Checks**
   ```javascript
   // Verify resource ownership
   if (resource.ownerId !== user.id && !user.isAdmin) {
     throw new ForbiddenError();
   }
   ```

3. **Use Parameterized Queries**
   ```javascript
   // Prevent SQL injection
   const result = await db.query(
     'SELECT * FROM users WHERE id = $1',
     [userId]
   );
   ```

### High Priority Fixes

1. **Input Validation**
   ```javascript
   const { body, validationResult } = require('express-validator');
   
   app.post('/api/users', [
     body('email').isEmail(),
     body('password').isLength({ min: 8 })
   ], (req, res) => {
     const errors = validationResult(req);
     if (!errors.isEmpty()) {
       return res.status(400).json({ errors: errors.array() });
     }
   });
   ```

2. **Session Security**
   ```javascript
   app.use(session({
     secret: process.env.SESSION_SECRET,
     secure: true,
     httpOnly: true,
     sameSite: 'strict'
   }));
   ```

## Continuous Security Testing

### CI/CD Integration

```yaml
name: Security Tests
on: [push, pull_request]

jobs:
  pentest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - name: Start Application
        run: npm run dev &
      - name: Wait for Application
        run: sleep 30
      - name: Run Penetration Tests
        run: node tests/pentest/run-pentest.js
      - name: Upload Results
        uses: actions/upload-artifact@v3
        with:
          name: pentest-results
          path: tests/pentest/results/
```

### Automated Monitoring

```bash
# Daily security scans
0 2 * * * cd /path/to/project && node tests/pentest/run-pentest.js --quick

# Weekly full penetration tests
0 2 * * 0 cd /path/to/project && node tests/pentest/run-pentest.js
```

## Best Practices

### Secure Development

1. **Input Validation**
   - Validate all user inputs
   - Use whitelist validation
   - Sanitize data before processing

2. **Authentication Security**
   - Use strong JWT secrets
   - Implement proper session management
   - Add multi-factor authentication

3. **Authorization Controls**
   - Implement role-based access control
   - Verify resource ownership
   - Use principle of least privilege

4. **Data Protection**
   - Encrypt sensitive data
   - Use HTTPS everywhere
   - Implement proper key management

### Testing Strategy

1. **Regular Testing**
   - Run security tests on every deployment
   - Perform monthly comprehensive assessments
   - Test after major code changes

2. **Comprehensive Coverage**
   - Test all API endpoints
   - Include edge cases and error conditions
   - Test with different user roles

3. **Realistic Scenarios**
   - Use real-world attack patterns
   - Test with actual user data
   - Simulate production conditions

## Troubleshooting

### Common Issues

1. **Target Not Accessible**
   ```bash
   # Check if application is running
   curl http://localhost:3001/health
   
   # Verify configuration
   cat tests/pentest/pentest-config.json
   ```

2. **Authentication Failures**
   ```bash
   # Check test user credentials
   # Verify JWT secret configuration
   # Ensure database is populated with test users
   ```

3. **False Positives**
   ```bash
   # Review finding evidence
   # Manually verify vulnerabilities
   # Adjust detection logic if needed
   ```

### Debug Mode

```bash
# Run with verbose output
DEBUG=pentest node tests/pentest/run-pentest.js

# Test specific module
node tests/pentest/modules/authentication-tests.js
```

## Support

For penetration testing issues:

1. Review test results in `tests/pentest/results/`
2. Check application logs for errors
3. Verify target application is accessible
4. Ensure test user accounts exist
5. Review configuration settings

## Contributing

When adding new penetration tests:

1. Follow existing module structure
2. Add comprehensive test scenarios
3. Include proper vulnerability detection
4. Document new attack vectors
5. Update this README with new tests
6. Ensure tests are reliable and repeatable